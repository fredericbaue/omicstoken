# OmicsToken ‚Äì Codex Memory Log (Append-Only)

---------------------------------------------------------
## 2025-12-01 ‚Äì ESM-2 Embeddings Integrated
- Embedding engine now uses ESM-2 (facebook/esm2_t6_8M_UR50D) with 320-dim output.
- Implemented in embeddings.py with lazy-loaded tokenizer/model and mean pooling
  over residue tokens.
- Returns a zero vector if the model fails to load or an embedding cannot be
  generated.
- EMBEDDING_DIM constant set to 320 and imported throughout the app to validate
  embedding shapes.

---------------------------------------------------------
## 2025-11-30 ‚Äì Fingerprint Endpoint Added
- New route: GET /runs/{run_id}/fingerprint.
- Fetches peptide embeddings for a run and requires at least 4 peptides to avoid
  scikit-learn crashes.
- Uses KMeans (n_clusters=4) and PCA (2 components) to generate:
  - cluster summaries (size, mean length, hydrophobicity, intensity)
  - 2D embedding coordinates with cluster labels.
- Returns JSON for downstream visualization in the dashboard.

---------------------------------------------------------
## 2025-11-30 ‚Äì Run Comparison Endpoint Added
- New route: GET /compare/{run_id_1}/{run_id_2}.
- Uses DISTINCT annotation_name from features as peptide sequences.
- Normalizes lists to JSON-safe strings and filters None values.
- Computes:
  - total unique peptides per run
  - shared peptides
  - unique peptides per run
  - Jaccard index across the union.
- Returns top 100 items per list for readability.

---------------------------------------------------------
## 2025-11-28 ‚Äì OmicsToken Export v1 Completed
- New route: GET /export/embeddings/{run_id} with response_model=OmicsTokenExportV1.
- Reads raw embeddings from peptide_embeddings via db.get_peptide_embeddings.
- Normalizes records into OmicsTokenV1 objects and wraps them in an export
  payload: run_id, total_embeddings, data[].
- CLI script export_run.py added:
  - Reads API_TOKEN from env or --token argument.
  - Calls /export/embeddings/{run_id} with Bearer token.
  - Writes JSON file named {run_id}_omics_export_v1.json into an output directory.

---------------------------------------------------------
## 2025-11-27 ‚Äì Global Index Rebuild Implemented
- After embedding peptides, the system calls search.rebuild_faiss_index with the
  DB connection and data directory.
- FAISS index is built globally from all rows in peptide_embeddings.
- Ensures cross-run nearest neighbor search is coherent.

---------------------------------------------------------
## 2025-11-26 ‚Äì Background Task Embedding
- Upload handler (/upload) parses CSV/TSV with format auto-detection and uses
  importers.parse_upload to generate Feature objects.
- Stores run metadata and features in SQLite.
- Uses FastAPI BackgroundTasks + run_in_threadpool to call embed(run_id) without
  blocking the event loop.
- embed(run_id) reads all features, generates embeddings with peptide_to_vector,
  stores rows in peptide_embeddings, and triggers FAISS index rebuild.
- Each successful upload increments the user‚Äôs credits in users.db.

---------------------------------------------------------
## 2025-11-24 ‚Äì Peptide Explanation Added
- New route: GET /peptide/explain/{run_id}/{feature_id}.
- Verifies run ownership via current_active_user.
- Fetches peptide sequence and intensity from features.
- Computes basic biophysical properties (length, hydrophobicity, charge).
- Retrieves similar peptides via search.search_similar_peptides (k=10).
- Calls Gemini (GOOGLE_API_KEY) to generate a two-paragraph explanation that
  references sequence, properties, and neighbors.
- Returns structured JSON with peptide metadata, neighbors, and explanation text.

---------------------------------------------------------
## 2025-11-20 ‚Äì Real Dataset Validated
- First real immuno-peptidomics tumor dataset successfully ingested and processed.
- Verified:
  - /upload ‚Üí features in DB
  - /peptide/embed/{run_id} ‚Üí embeddings generated and stored
  - search similarity pipeline
  - basic summaries and dashboards.

---------------------------------------------------------
## 2025-11-18 ‚Äì Architecture Committed
- FastAPI selected as main web framework.
- SQLite selected for MVP storage (immuno.sqlite + users.db).
- Modularization agreed:
  - db.py for DB access and schema creation/migrations.
  - embeddings.py for embedding logic.
  - auth.py for auth and user management with fastapi-users.
  - app.py as the main router for upload, embedding, search, comparison, summary,
    fingerprint, export, and dashboard data.

---------------------------------------------------------
## 2025-11-15 ‚Äì Vision Crystallized
- Reframed project as an embedding/tokenization engine for omics, not just a
  one-off analysis pipeline.
- Immuno-peptidomics selected as the beachhead due to high value and lack of
  existing embedding standards.
- Confirmed long-term plan:
  - Lab SaaS ‚Üí multi-omics embedding platform ‚Üí tokenized dataset marketplace.

---------------------------------------------------------
## 2025-11-10 ‚Äì Project Inception
- Core idea: convert scientific data (starting with peptides) into vectors so
  that semantic search, comparison, and AI interpretation become first-class
  workflows for labs and biotech.
---------------------------------------------------------
## 2025-12-01 - Export Auth Hardened (Task 1.1)
- export_run.py now requires a Bearer token from --token or API_TOKEN env, fails fast when missing, and prints clear messages for 401/404 responses; successful calls still write {run_id}_omics_export_v1.json.
- Usage: set API_TOKEN in the environment, then run `python scripts/export_run.py <run_id> --base-url http://localhost:8000`; or pass explicitly `python scripts/export_run.py <run_id> --base-url http://localhost:8000 --token YOUR_TOKEN`.
---------------------------------------------------------
## 2025-12-01 - FAISS Rebuild Hardened (Task 1.2)
- search.rebuild_faiss_index now opens a fresh DB connection when None for thread safety, builds into temporary files, and atomically swaps them; failures return 0, log, and leave the prior index intact; empty datasets remove old index artifacts.
- embed/delete flows now call rebuild with thread-safe connection handling and log failures; re_embed_all script updated to use the hardened rebuild.
- Added tests (tests/test_rebuild_faiss_index.py) for happy path and simulated write failure.
- Usage: call search.rebuild_faiss_index(None, DATA_DIR) when running from background threads; index files are replaced only after a successful build.
---------------------------------------------------------
## 2025-12-01 - ESM-2 Engine Stabilized (Task 1.3)
- embeddings.py now caches tokenizer/model globally, normalizes sequences (strip+upper), warns on invalid input, and returns a deterministic 320-dim zero vector on invalid input or model/shape failures.
- All embeddings enforce EMBEDDING_DIM==320; shape mismatches or HF errors log and fall back to zero without crashing.
- Added tests (tests/test_embeddings_engine.py) covering valid embeddings, invalid/empty sequences returning zeros, and model/tokenizer caching (single load).
- Usage: continue calling peptide_to_vector(seq); it now guarantees a float32 vector of length 320 and handles invalid inputs gracefully.
---------------------------------------------------------
## 2025-12-01 - Background Tasks Hardened (Task 1.4)
- Each FAISS rebuild is serialized with a process-level lock; background callers pass None so rebuild opens/closes its own DB connection safely; waits are logged when another rebuild is in progress.
- embed() now wraps DB work in try/except/finally with rollback-on-error and still triggers thread-safe rebuild; connections always close.
- Added concurrency test (tests/test_background_db_safety.py) to ensure overlapping rebuilds do not overlap writes and artifacts remain valid.
- Usage: background tasks should call search.rebuild_faiss_index(None, DATA_DIR); rebuild waits if another is running, then atomically swaps index files.
---------------------------------------------------------
## 2025-12-01 - Endpoint Robustness (Task 1.5)
- All user-scoped routes now enforce run ownership consistently; embedding helper (_embed_run) is shared by the route and background tasks and checks owner IDs, using per-task DB connections with rollback on error.
- FAISS rebuild remains serialized and is invoked thread-safely after embeds; unexpected failures surface as clean HTTP errors instead of crashes.
- Added tests (tests/test_endpoint_ownership.py) to cover ownership enforcement for export and embed routes.
- Usage: routes that touch runs require the authenticated user to own the run; unauthorized access returns 404/403-style HTTPExceptions without leaking details.
---------------------------------------------------------
## 2025-12-01 - Legacy Embeddings Isolated (Task 2.1)
- Marked the old `embeddings` table in db.py as LEGACY/compat-only; canonical flows use `peptide_embeddings` exclusively with clarified docstrings.
- Active helpers (get_embedding/get_all_embeddings_data/insert_peptide_embedding) target `peptide_embeddings`; legacy insert is labeled to avoid accidental use.
- Added test (tests/test_legacy_table_isolation.py) to assert canonical getters avoid legacy table usage.
- Usage: new code must read/write embeddings via peptide_embeddings; legacy table remains only for migration compatibility.
---------------------------------------------------------
## 2025-12-01 - Embedder Interface Added (Task 2.2)
- Added BaseEmbedder interface and Esm2Embedder implementation with cached tokenizer/model, normalized sequences (strip+upper), and deterministic zero-vector fallback; kept EMBEDDING_DIM=320.
- peptide_to_vector now delegates to a default Esm2Embedder, preserving public behavior while enabling swap-in embedders.
- Updated tests (tests/test_embeddings_engine.py) to cover the interface, zero-vector fallback, caching, and wrapper behavior.
- Usage: continue calling peptide_to_vector(seq) or use Esm2Embedder.embed; both return float32 vectors of length 320 with safe fallbacks.
---------------------------------------------------------
## 2025-12-01 - Config & Embedder Factory (Task 2.3)
- Added config.py to centralize DATA_DIR, EMBEDDER_NAME, and ESM model name; app/re_embed_all now import DATA_DIR from config.
- embeddings.py now uses config for model selection and includes an embedder factory (create_embedder) with Esm2Embedder as the default; peptide_to_vector delegates via the factory.
- Tests updated (tests/test_embeddings_engine.py) to verify default Esm2 selection, zero-vector fallback, caching, and factory error on unknown embedder.
- Usage: by default EMBEDDER_NAME=esm2 and ESM_MODEL_NAME=facebook/esm2_t6_8M_UR50D; override via env if future alternate embedders are added.
---------------------------------------------------------
## 2025-12-01 - Config Defaults Documented (Task 2.4)
- config.py now documents defaults for DATA_DIR, EMBEDDER_NAME (default esm2), and ESM_MODEL_NAME; all modules use config for these settings.
- Added sanity test (tests/test_config_sanity.py) to validate default config import, embedder factory defaulting to Esm2, and DATA_DIR creation.
- Updated scripts/tests to reference DATA_DIR via config for consistency.
---------------------------------------------------------
## 2025-12-01 - Logging Centralized (Task 2.5)
- Added centralized logging config (config.py) with env-controlled level/format; defaults to INFO and avoids leaking sensitive data.
- Key pipeline paths now log via module loggers instead of prints (upload, embed/background embedding, rebuilds); warnings/errors use logging consistently.
- Added sanity test (tests/test_logging_sanity.py) to ensure logging config loads, DATA_DIR is set, and embedder warnings emit logs.
- Usage: adjust LOG_LEVEL/LOG_FORMAT env vars; default embedder and pipeline behavior unchanged.
---------------------------------------------------------
## 2025-12-01 - Pivot to Product/UX
- Recorded upcoming structural task 2.6 (request/response logging middleware with redaction & correlation IDs) for later.
- Added Product/UX section with tasks 4.1‚Äì4.4; 4.1 will surface run lists with metadata and links to summary/fingerprint/compare/export flows for scientists.
---------------------------------------------------------
## 2025-12-01 - Scientist Run Dashboard (Task 4.1)
- runs.html now shows status badges (Ready/Processing/Not embedded) based on embedding counts, grouped action buttons (Explore, Maintenance, Danger), and inline hints for incomplete/empty runs.
- Added client-side search and status filtering for runs (by run_id/filename/instrument) without backend changes.
- Styling kept minimal and consistent with the classic UI.
---------------------------------------------------------
## 2025-12-01 - Fingerprint Insight Panel (Task 4.2)
- fingerprint.html now shows an insight summary card (totals, largest/smallest clusters) with PI-friendly phrasing.
- Cluster rows are clickable; selecting highlights PCA points, dims others, and shows a Selected Cluster panel with stats and a one-line interpretation.
- Added a short ‚ÄúHow to read this‚Äù explainer under the PCA plot and navigation links to Runs and Summary.
- Improved error handling: clean messages for 400/404 and graceful skips for missing cluster fields.
---------------------------------------------------------
## 2025-12-01 - Cluster ‚Üí Peptide Drilldown (Task 4.2.1)
- Added a drilldown panel in fingerprint.html that shows peptides for the selected cluster with sorting, 50-at-a-time pagination, and dark-theme styling.
- Selecting a cluster now reveals its peptides (sequence, length, hydrophobicity, intensity) and reuses the PCA highlighting.
- Improved usability for PIs: see cluster summary, highlight on PCA, and immediately inspect underlying peptides without backend changes.
---------------------------------------------------------
## 2025-12-01 - Multi-Run Export Bundle (Task 5.1)
- Added POST /export/bundle to package multiple OmicsToken v1 JSON exports into an in-memory ZIP (one file per run + bundle.json manifest) with ownership/embedding validation (all-or-nothing).
- New CLI scripts/export_bundle.py posts run_ids, saves omics_bundle_<timestamp>.zip, and handles token/env resolution and errors.
- Tests (tests/test_export_bundle.py) cover unauthorized, success ZIP structure, and incomplete-run 400 responses.
---------------------------------------------------------
## 2025-12-01 - Automated Insight Report (Task 5.2)
- Added GET /report/{run_id} to return a structured insight report (cluster stats, largest/smallest, hydrophobicity patterns, plain-language summary) derived from existing fingerprints with ownership/embedding validation.
- New frontend viewer /static/report.html to render the report with navigation to Summary/Fingerprint/Compare.
- Tests (tests/test_report_endpoint.py) cover unauthorized, success, incomplete-run 400, and wrong-owner 404.
---------------------------------------------------------
## 2025-12-01 - Programmatic Upload & API Tokens (Task 5.3)
- Added API tokens: POST /auth/api-tokens returns a one-time plain token (hash stored); DELETE /auth/api-tokens/{id} revokes tokens; auth helper now accepts Bearer API tokens in addition to JWT.
- New programmatic upload endpoint POST /api/runs (supports auto_embed) using existing pipeline; validates ownership and features.
- CLI scripts/upload_run.py posts runs with features JSON and optional auto-embed using API_TOKEN or --token.
- Tests (tests/test_api_tokens_and_upload.py) cover token creation response, API token auth for /api/runs, and feature validation.
## 2025-12-01 ñ UX.C1 Run List Refactor
- Primary actions (Dashboard, Summary, Search) remain visible per run.
- Secondary/maintenance actions (Fingerprint, Re-embed, Delete) moved into a "More..." dropdown with keyboard + click closing logic.
- No backend changes; behavior preserved. Front-end only.
---------------------------------------------------------
## 2025-12-02 - UX.H2 Cross-Contextual Search Linking
- Dashboard and fingerprint peptide entries now link to search.html with run_id and feature_id prefilled.
- search.html auto-selects run/peptide from query params, auto-runs neighbor search, and shows a context banner; manual selection still works.
- Front-end only; no backend routes or schemas changed.
---------------------------------------------------------
## 2025-12-02 - UX.H3 Post-Upload Funnel
- Upload page now shows a guided success panel with run_id, rows ingested, background embedding note, and direct links to Run Dashboard and My Runs.
- Errors are shown inline without navigation; form stays usable; no backend changes.
## 2025-12-02 - Explanation View JS Cleanup
- Removed stray diff markers in static/explain.html (loadNeighbors, loadExplanation, init); JavaScript now valid and behavior unchanged.
- search.html left untouched; no backend changes.
---------------------------------------------------------
## 2025-12-01 ñ UX Deep Linking & Logging Middleware

- Refined the runs list UI (static/runs.html) so primary actions (Dashboard, Summary, Search) remain visible while secondary actions (Fingerprint, Re-embed, Delete) are consolidated into a ìMoreÖî dropdown, reducing clutter and making the main workflow obvious.
- Added cross-context deep linking: top peptides in simple_dashboard.html and cluster drilldown peptides in fingerprint.html now link directly into search.html with run_id/feature_id pre-populated and the similarity search + explanation auto-run.
- Upgraded the upload flow (static/upload.html) to show a guided success funnel after POST /upload, including run ID, rows ingested, and clear CTAs to ìOpen Run Dashboardî and ìGo to My Runs,î plus inline error cards on failure without leaving the page.
- Introduced a dedicated peptide explanation view (static/explain.html) that is deep-linkable via ?run_id=...&feature_id=..., fetches neighbors and /peptide/explain, and presents an ìAI insight sheetî with sequence, properties, neighbors, and a Gemini-labeled explanation.
- Implemented request/response logging middleware in app.py that logs method, path, query, status, latency_ms, correlation_id, and best-effort user identifier; correlation IDs are sourced from X-Correlation-ID/X-Request-ID when provided or generated via UUID, attached to request.state and echoed in the response headers.
---------------------------------------------------------
## 2025-12-02 - Tiny UX Encoding/Copy Polish
- Cleaned mojibake across runs.html, fingerprint.html, and search.html: credits badge defaults now read "Credits: 0", partial-embedding hint text is readable, Back to Runs button text fixed, and the full explanation link arrow renders correctly.
- Left all logic and endpoints unchanged; edits were limited to static copy/encoding fixes.
---------------------------------------------------------
## 2025-12-02 - DB Backend Config Scaffolding
- Added DB_BACKEND/DATABASE_URL/USERS_DATABASE_URL configuration in db.py with defaults for SQLite; non-sqlite backends raise a clear error placeholder.
- Centralized DB path helpers (get_db_path, get_users_db_path) so SQLite paths are no longer hard-coded; user credits now use the resolved users DB path.
- Observable behavior remains SQLite-by-default; Postgres can be wired later without touching routes.
---------------------------------------------------------
## 2025-12-02 ñ DB backend prep for Postgres

- Introduced DB_BACKEND, DATABASE_URL, and USERS_DATABASE_URL configuration in db.py, defaulting to the existing sqlite behavior.
- Updated get_db_connection(...) so sqlite is the explicit default and other backends raise a clear NotImplementedError until implemented.
- Removed hard-coded "data/users.db" in get_user_credits(...) and replaced it with a configurable helper (_get_users_db_path) that still defaults to the legacy path for sqlite.
- This establishes a single configuration point for the main and user/credits databases, making a future Postgres migration a targeted change instead of a codebase-wide search/rewrite.
---------------------------------------------------------
## 2025-12-02 ñ Credits UI (monetization surface)

- Made the credits badge on the My Runs page clickable and keyboard-accessible.
- Added a modal showing the current balance from /runs and explaining that uploads and AI features consume credits; includes a "Coming soon" note for upgrade plans.
- No backend or billing changes; front-end-only monetization surface.
