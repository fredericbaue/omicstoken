<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proteomics Scientific Workbench</title>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="/static/dashboard.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#151f32',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar for scientific feel */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body class="dashboard-body">
    <div class="dashboard-shell">
        <!-- Sidebar: Peptide List -->
        <aside class="dashboard-panel dashboard-panel--sidebar">
            <div class="dashboard-panel__header">
                <p class="dashboard-title">ACTIVE OMICSTOKEN PROJECT</p>
                <h1 class="dashboard-hero-label">Dashboard</h1>
                <div class="dashboard-control-group">
                    <select id="runSelect" class="dashboard-input">
                        <option value="">Select a run...</option>
                    </select>
                    <button onclick="loadRealData()" class="sidebar-button primary">Load Run</button>
                    <button onclick="simulateDataLoad()" class="sidebar-button secondary">Simulate Data</button>
                </div>
            </div>

            <div class="dashboard-list" id="peptideList">
                <div class="dashboard-empty">Load data to view peptides</div>
            </div>
            <div class="dashboard-panel__footer">
                <span>Items: <span id="itemCount">0</span></span>
                <span>v0.4.0-beta</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Top Pane -->
            <section class="dashboard-card dashboard-card--figure">
                <div class="dashboard-figure-label" id="figureLabel">FIGURE 1: HYDROPHOBICITY vs. MW</div>
                <div id="scatterPlot" class="dashboard-figure"></div>
            </section>

            <!-- Bottom Pane -->
            <section class="dashboard-card dashboard-card--detail">
                <div id="detailView" class="dashboard-detail hidden">
                    <div class="dashboard-detail__header">
                        <div>
                            <h2 id="detailSeq"></h2>
                            <div class="dashboard-detail__meta">
                                <span class="dashboard-chip">ID: <span id="detailId">---</span></span>
                                <span class="dashboard-chip">Charge: <span id="detailCharge">---</span></span>
                            </div>
                        </div>
                        <div class="dashboard-detail__intensity">
                            <div>Intensity</div>
                            <div id="detailIntensity">---</div>
                        </div>
                    </div>

                    <div class="dashboard-stat-grid">
                        <div class="dashboard-stat">
                            <div class="dashboard-stat__label">Hydrophobicity</div>
                            <div class="dashboard-stat__value" id="detailHydro">---</div>
                            <div class="dashboard-progress">
                                <div id="barHydro" class="dashboard-progress__bar" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="dashboard-stat">
                            <div class="dashboard-stat__label">Molecular Weight</div>
                            <div class="dashboard-stat__value" id="detailMW">---</div>
                            <div class="dashboard-stat__hint">Daltons</div>
                        </div>
                        <div class="dashboard-stat">
                            <div class="dashboard-stat__label">Length</div>
                            <div class="dashboard-stat__value" id="detailLen">---</div>
                            <div class="dashboard-stat__hint">Amino Acids</div>
                        </div>
                    </div>

                    <div class="dashboard-actions">
                        <h3>Analysis Tools</h3>
                        <div class="dashboard-action-buttons">
                            <button id="foldStructureBtn" class="btn btn-primary btn-small">Fold Structure</button>
                            <button class="btn btn-secondary btn-small" disabled title="Coming soon">Find Similar</button>
                            <button class="btn btn-secondary btn-small" disabled title="Coming soon">Predict Binding</button>
                            <button class="btn btn-secondary btn-small" disabled title="Coming soon">Export FASTA</button>
                        </div>
                    </div>
                </div>

                <div id="emptyState" class="dashboard-empty dashboard-empty--large">
                    <p>Select a data point to view biophysical details</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- State ---
        let currentData = [];
        let selectedFeatureMeta = null;
        const runSelect = document.getElementById('runSelect');
        const foldStructureBtn = document.getElementById('foldStructureBtn');
        const foldBtnDefaultLabel = foldStructureBtn ? foldStructureBtn.textContent.trim() : "Fold Structure";

        function getToken() {
            return window.localStorage.getItem("token") || "";
        }

        function authHeaders() {
            const headers = {};
            const token = getToken();
            if (token) headers["Authorization"] = `Bearer ${token}`;
            return headers;
        }

        function setFoldButtonState(disabled, label) {
            if (!foldStructureBtn) return;
            foldStructureBtn.disabled = disabled;
            foldStructureBtn.textContent = label || foldBtnDefaultLabel;
            foldStructureBtn.style.opacity = disabled ? "0.5" : "1";
            foldStructureBtn.style.cursor = disabled ? "not-allowed" : "pointer";
        }

        async function queueStructureAnalysis() {
            if (!foldStructureBtn || !selectedFeatureMeta) return;
            const sequence = selectedFeatureMeta.sequence;
            if (!sequence) {
                alert("This feature does not have a valid sequence.");
                return;
            }

            const runId = runSelect.value.trim();
            if (!runId) {
                alert("Please select a Run ID before triggering structure analysis.");
                return;
            }

            const token = getToken();
            if (!token) {
                alert("Please log in first (token missing).");
                return;
            }

            setFoldButtonState(true, "Queuing...");
            try {
                const res = await fetch(
                    `/runs/${encodeURIComponent(runId)}/features/${encodeURIComponent(selectedFeatureMeta.feature_id)}/structure?engine=mock`,
                    {
                        method: "POST",
                        headers: {
                            ...authHeaders(),
                        },
                    }
                );
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data.detail || JSON.stringify(data));
                }
                alert(`Structure analysis started! Task ID: ${data.task_id || "unknown"}`);
            } catch (err) {
                console.error(err);
                alert("Failed to start analysis.");
            } finally {
                setFoldButtonState(false);
            }
        }

        if (foldStructureBtn) {
            setFoldButtonState(true);
            foldStructureBtn.addEventListener("click", queueStructureAnalysis);
        }

        // --- Simulation ---
        function simulateDataLoad() {
            const peptides = [];
            const aas = 'ACDEFGHIKLMNPQRSTVWY';

            for (let i = 0; i < 200; i++) {
                // Generate random sequence
                const len = 7 + Math.floor(Math.random() * 15);
                let seq = '';
                for (let j = 0; j < len; j++) seq += aas[Math.floor(Math.random() * aas.length)];

                // Mock properties
                const hydro = (Math.random() * 6) - 3; // -3 to +3
                const mw = len * 110 + (Math.random() * 50);
                const intensity = Math.pow(10, 4 + Math.random() * 5); // 10^4 to 10^9

                peptides.push({
                    feature_id: `SIM_${i}`,
                    sequence: seq,
                    intensity: intensity,
                    properties: {
                        hydrophobicity: parseFloat(hydro.toFixed(2)),
                        molecular_weight: Math.floor(mw),
                        charge: Math.floor(Math.random() * 5) - 2,
                        length: len
                    }
                });
            }

            renderDashboard(peptides);
        }

        // --- Real Data Load ---
        async function loadRealData(runOverride) {
            const runId = (runOverride || runSelect.value || "").trim();
            if (!runId) {
                alert("Please select a Run ID");
                return;
            }
            runSelect.value = runId;
            updateUrl(runId);

            try {
                const btn = document.querySelector('button[onclick="loadRealData()"]');
                const originalText = btn.innerText;
                btn.innerText = "LOADING...";
                btn.disabled = true;

                const token = localStorage.getItem('token');
                const res = await fetch(`/dashboard-data/${runId}`, {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                if (!res.ok) throw new Error("Failed to fetch data");

                const json = await res.json();
                renderDashboard(json.data);

                btn.innerText = originalText;
                btn.disabled = false;
            } catch (e) {
                alert("Error loading data: " + e.message);
                const retryBtn = document.querySelector('button[onclick="loadRealData()"]');
                retryBtn.innerText = "Load Run";
                retryBtn.disabled = false;
            }
        }

        function updateUrl(runId) {
            const url = new URL(window.location.href);
            if (runId) {
                url.searchParams.set('run_id', runId);
            } else {
                url.searchParams.delete('run_id');
            }
            window.history.replaceState({}, '', url.toString());
        }

        async function populateRunSelect(activeRunId) {
            const token = localStorage.getItem('token');
            const setOptions = (runIds) => {
                const unique = [];
                const seen = new Set();
                runIds.forEach(id => {
                    if (id && !seen.has(id)) {
                        seen.add(id);
                        unique.push(id);
                    }
                });
                if (activeRunId && !seen.has(activeRunId)) {
                    unique.unshift(activeRunId);
                }
                runSelect.innerHTML = '<option value="">Select a run...</option>';
                unique.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = id;
                    runSelect.appendChild(option);
                });
                if (activeRunId && unique.includes(activeRunId)) {
                    runSelect.value = activeRunId;
                } else if (unique.length) {
                    runSelect.value = unique[0];
                }
            };

            if (!token) {
                setOptions(activeRunId ? [activeRunId] : []);
                return;
            }

            try {
                const res = await fetch('/runs', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) {
                    throw new Error('Failed to load runs');
                }
                const payload = await res.json();
                const ids = Array.isArray(payload.runs)
                    ? payload.runs.map(run => run.run_id).filter(Boolean)
                    : [];
                setOptions(ids.length ? ids : (activeRunId ? [activeRunId] : []));
            } catch (err) {
                console.warn('Failed to fetch runs', err);
                setOptions(activeRunId ? [activeRunId] : []);
            }
        }

        runSelect.addEventListener('change', () => {
            const runId = runSelect.value.trim();
            updateUrl(runId);
            if (runId) {
                loadRealData();
            }
        });

        (async function initDashboard() {
            const params = new URLSearchParams(window.location.search);
            const runId = params.get('run_id');
            await populateRunSelect(runId);
            if (runId) {
                loadRealData(runId);
            } else if (runSelect.value.trim()) {
                loadRealData(runSelect.value.trim());
            }
        })();

        // --- Rendering ---
        function renderDashboard(data) {
            currentData = data;
            document.getElementById('itemCount').innerText = data.length;

            renderList(data);

            const figureLabel = document.getElementById('figureLabel');
            const hasVolcano = renderVolcano(data);
            if (hasVolcano) {
                if (figureLabel) {
                    figureLabel.innerText = "FIGURE 1: VOLCANO PLOT (Differential Expression)";
                }
            } else {
                renderScatter(data);
                if (figureLabel) {
                    figureLabel.innerText = "FIGURE 1: HYDROPHOBICITY vs. MW";
                }
            }
        }

        function renderList(data) {
            const list = document.getElementById('peptideList');
            list.innerHTML = '';

            data.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = "dashboard-peptide";
                div.onclick = () => selectPeptide(idx);

                const runId = runSelect.value || '';
                div.innerHTML = `
                    <div class="dashboard-peptide__title">
                        <a href="/static/search.html?run_id=${encodeURIComponent(runId)}&sequence=${encodeURIComponent(p.sequence)}">${p.sequence}</a>
                    </div>
                    <div class="dashboard-peptide__meta">
                        <span>MW: ${p.properties.molecular_weight}</span>
                        <span>Hyd: ${p.properties.hydrophobicity}</span>
                        <span>${p.intensity.toExponential(1)}</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderScatter(data) {
            const trace = {
                x: data.map(p => p.properties.molecular_weight),
                y: data.map(p => p.properties.hydrophobicity),
                mode: 'markers',
                type: 'scatter',
                text: data.map(p => p.sequence),
                marker: {
                    size: 8,
                    color: data.map(p => Math.log10(p.intensity)),
                    colorscale: 'Viridis',
                    opacity: 0.8,
                    line: { color: '#0f172a', width: 1 }
                },
                hoverinfo: 'text'
            };

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 20, r: 20, b: 40, l: 50 },
                xaxis: { title: 'Molecular Weight (Da)', color: '#94a3b8', gridcolor: '#1e293b' },
                yaxis: { title: 'Hydrophobicity (GRAVY)', color: '#94a3b8', gridcolor: '#1e293b' },
                hovermode: 'closest'
            };
            Plotly.newPlot('scatterPlot', [trace], layout, { responsive: true, displayModeBar: false });

            document.getElementById('scatterPlot').on('plotly_click', function (data) {
                selectPeptide(data.points[0].pointIndex);
            });
        }

        function renderVolcano(data) {
            // Filter out invalid data points
            const validData = data.filter(d => d.stats && d.stats.fold_change !== null && d.stats.q_value !== null);

            if (!validData.length) {
                Plotly.purge('scatterPlot');
                return false;
            }

            // Create colors based on significance
            const colors = validData.map(d => {
                if (d.stats.q_value < 0.05) {
                    return d.stats.fold_change > 0 ? '#ef4444' : '#3b82f6'; // Red for Up, Blue for Down
                }
                return '#475569'; // Grey for non-significant
            });

            const trace = {
                x: validData.map(d => d.stats.fold_change),
                y: validData.map(d => -Math.log10(d.stats.q_value)),
                mode: 'markers',
                type: 'scatter',
                text: validData.map(d => d.sequence),
                marker: {
                    size: 6,
                    color: colors,
                    opacity: 0.8,
                    line: { color: '#0f172a', width: 0.5 }
                },
                hoverinfo: 'text'
            };

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 20, r: 20, b: 40, l: 50 },
                xaxis: { title: 'Log2 Fold Change', color: '#94a3b8', gridcolor: '#1e293b', zerolinecolor: '#cbd5e1' },
                yaxis: { title: '-Log10 q-value', color: '#94a3b8', gridcolor: '#1e293b' },
                hovermode: 'closest',
                shapes: [
                    // Significance thresholds
                    { type: 'line', x0: -10, x1: 10, y0: -Math.log10(0.05), y1: -Math.log10(0.05), line: { color: '#94a3b8', width: 1, dash: 'dash' } }
                ]
            };

            Plotly.newPlot('scatterPlot', [trace], layout, { responsive: true, displayModeBar: false });

            document.getElementById('scatterPlot').on('plotly_click', function (evtData) {
                // Map back to original data index
                const pt = evtData.points[0];
                // Since we filtered, we need to find the object in the original array
                const selectedObj = validData[pt.pointIndex];
                const originalIndex = currentData.indexOf(selectedObj);
                selectPeptide(originalIndex);
            });

            return true;
        }

        function selectPeptide(index) {
            const p = currentData[index];
            if (!p) return;

            // Show Detail View
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('detailView').classList.remove('hidden');

            // Populate Data
            const detailSeqEl = document.getElementById('detailSeq');
            detailSeqEl.innerHTML = '';
            const seqLink = document.createElement('a');
            seqLink.href = `/static/search.html?run_id=${encodeURIComponent(runSelect.value || '')}&sequence=${encodeURIComponent(p.sequence)}`;
            seqLink.textContent = p.sequence;
            seqLink.className = "dashboard-link";
            detailSeqEl.appendChild(seqLink);
            document.getElementById('detailId').innerText = p.feature_id;
            document.getElementById('detailCharge').innerText = p.properties.charge > 0 ? `+${p.properties.charge}` : p.properties.charge;
            document.getElementById('detailIntensity').innerText = p.intensity.toExponential(2);

            document.getElementById('detailHydro').innerText = p.properties.hydrophobicity;
            document.getElementById('detailMW').innerText = p.properties.molecular_weight;
            document.getElementById('detailLen').innerText = p.properties.length;

            // Visual bar for hydrophobicity (-4.5 to 4.5 scale approx)
            const hydroPct = ((p.properties.hydrophobicity + 4.5) / 9) * 100;
            const bar = document.getElementById('barHydro');
            bar.style.width = `${Math.max(0, Math.min(100, hydroPct))}%`;
            bar.className = p.properties.hydrophobicity > 0
                ? "dashboard-progress__bar dashboard-progress__bar--positive"
                : "dashboard-progress__bar dashboard-progress__bar--negative";

            // Show Stats if available
            if (p.stats && p.stats.fold_change !== undefined) {
                const fcText = `FC: ${p.stats.fold_change.toFixed(2)}`;
                const qText = `q: ${p.stats.q_value?.toExponential(2)}`;
                document.getElementById('detailId').innerText = `${p.feature_id} | ${fcText} | ${qText}`;
            }

            selectedFeatureMeta = {
                feature_id: p.feature_id,
                sequence: p.sequence
            };
            setFoldButtonState(!p.sequence);
        }
    </script>
</body>

</html>


