<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Compare Runs - OmicsToken</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        :root {
            --shell-bg: rgba(15, 23, 42, 0.92);
            --shell-border: rgba(148, 163, 184, 0.25);
            --text-body: #e5e7eb;
            --text-muted: rgba(226, 232, 240, 0.7);
            --hero-shadow: 0 30px 80px rgba(2, 6, 23, 0.75);
        }
        body.compare-body {
            margin: 0;
            min-height: 100vh;
            font-family: "Inter", "SF Pro Text", -apple-system, system-ui, sans-serif;
            background: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
            color: var(--text-body);
        }
        .compare-shell {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 1.75rem 4rem;
        }
        .back-link {
            color: rgba(148, 163, 184, 0.9);
            text-decoration: none;
            font-size: 0.95rem;
        }
        .back-link:hover {
            color: white;
        }
        .compare-hero {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
            flex-wrap: wrap;
            background: var(--shell-bg);
            border: 1px solid var(--shell-border);
            border-radius: 28px;
            padding: 2rem 2.25rem;
            box-shadow: var(--hero-shadow);
            margin: 1.5rem 0 2rem;
        }
        .compare-kicker {
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.3em;
            color: rgba(148, 163, 184, 0.9);
            margin: 0;
        }
        .compare-hero-copy h1 {
            font-size: 2.3rem;
            margin: 0.35rem 0 0.4rem;
            letter-spacing: -0.02em;
            background: linear-gradient(120deg, #38bdf8, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .compare-hero-copy p {
            margin: 0;
            color: var(--text-muted);
            max-width: 46ch;
            line-height: 1.55;
        }
        .compare-hero-actions {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            align-items: flex-start;
        }
        .compare-card {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 24px;
            padding: 1.75rem 2rem;
            margin-bottom: 1.75rem;
            box-shadow: 0 24px 65px rgba(2, 6, 23, 0.7);
        }
        .compare-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            align-items: flex-end;
            margin-top: 1.25rem;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: rgba(226, 232, 240, 0.8);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 0.78rem;
        }
        select {
            width: 100%;
            padding: 0.65rem 0.9rem;
            border-radius: 12px;
            border: 1px solid rgba(51, 65, 85, 0.9);
            background: rgba(2, 6, 23, 0.7);
            color: #f8fafc;
            font-size: 0.95rem;
        }
        select:disabled {
            opacity: 0.6;
        }
        .btn {
            border-radius: 999px;
            padding: 0.8rem 1.6rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            border: none;
            cursor: pointer;
            transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
        }
        .btn.btn-primary {
            background: linear-gradient(135deg, #6366f1, #22c1c3);
            color: white;
            box-shadow: 0 22px 45px rgba(79, 70, 229, 0.55);
        }
        .btn.btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            filter: brightness(1.05);
            box-shadow: 0 28px 60px rgba(79, 70, 229, 0.75);
        }
        .btn:disabled {
            background: rgba(148, 163, 184, 0.4);
            box-shadow: none;
            cursor: not-allowed;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .stat-item {
            background: rgba(2, 6, 23, 0.65);
            border-radius: 16px;
            padding: 1.1rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            text-align: center;
        }
        .stat-label {
            color: rgba(226, 232, 240, 0.65);
            font-size: 0.85rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            margin-top: 0.4rem;
            color: #38bdf8;
        }
        .peptide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.35rem;
        }
        .peptide-section {
            background: rgba(2, 6, 23, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 18px;
            padding: 1.25rem;
        }
        .peptide-section h3 {
            margin: 0 0 0.8rem;
            font-size: 1rem;
            letter-spacing: 0.02em;
            color: var(--text-body);
        }
        .peptide-list {
            max-height: 380px;
            overflow-y: auto;
            font-family: "JetBrains Mono", monospace;
            font-size: 0.9rem;
        }
        .peptide-item {
            padding: 0.55rem 0.7rem;
            margin-bottom: 0.35rem;
            background: rgba(15, 23, 42, 0.85);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        .peptide-item:hover {
            background: rgba(59, 130, 246, 0.18);
            transform: translateX(2px);
        }
        .shared { border-left: 4px solid #10b981; }
        .unique1 { border-left: 4px solid #38bdf8; }
        .unique2 { border-left: 4px solid #f59e0b; }
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: rgba(226, 232, 240, 0.5);
        }
        .truncation-note {
            font-size: 0.8rem;
            color: rgba(226, 232, 240, 0.6);
        }
        .warning-message,
        .error-message {
            border-radius: 14px;
            padding: 0.9rem 1.2rem;
            margin-bottom: 1rem;
        }
        .error-message {
            background: rgba(248, 113, 113, 0.15);
            border-left: 4px solid #ef4444;
        }
        .warning-message {
            background: rgba(234, 179, 8, 0.2);
            border-left: 4px solid #f59e0b;
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="compare-body">
    <main class="compare-shell">
        <a href="/static/runs.html" class="back-link">&larr; Back to Runs</a>
        <section class="compare-hero">
            <div class="compare-hero-copy">
                <p class="compare-kicker">Cross-run insights</p>
                <h1>Compare Runs</h1>
                <p>Overlay any two peptide runs to spot overlaps, divergences, and shared therapeutic signals. Fast, visual attribution for scientists and demo audiences alike.</p>
            </div>
            <div class="compare-hero-actions">
                <p class="text-muted">Pick two runs from your workspace and hit compare.</p>
                <button id="compareBtnHero" class="btn btn-primary" onclick="compareRuns()" disabled>Compare Runs</button>
            </div>
        </section>

        <section class="compare-card">
            <h2>Select Runs</h2>
            <div class="compare-form">
                <div class="form-group">
                    <label for="run1Select">Run 1</label>
                    <select id="run1Select" disabled>
                        <option>Loading runs...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="run2Select">Run 2</label>
                    <select id="run2Select" disabled>
                        <option>Loading runs...</option>
                    </select>
                </div>
                <button id="compareBtn" class="btn btn-primary" onclick="compareRuns()" disabled>Compare</button>
            </div>
            <div id="errorContainer" style="margin-top:1rem;"></div>
        </section>

        <section id="results" style="display:none;">
            <div id="warningContainer"></div>

            <div class="compare-card">
                <h2>Comparison Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Run 1 Peptides</div>
                        <div class="stat-value" id="run1Total">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Run 2 Peptides</div>
                        <div class="stat-value" id="run2Total">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Shared Peptides</div>
                        <div class="stat-value" id="sharedCount">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Jaccard Index</div>
                        <div class="stat-value" id="jaccardIndex">-</div>
                    </div>
                </div>
            </div>

            <div class="compare-card">
                <h2>Peptide Sets</h2>
                <div class="peptide-grid">
                    <div class="peptide-section">
                        <h3 id="unique1Header">Unique to Run 1 (<span id="unique1Count">0</span>)</h3>
                        <div class="peptide-list" id="unique1List"></div>
                        <div class="truncation-note" id="unique1Note" style="display:none;">Showing first 100 peptides</div>
                    </div>
                    <div class="peptide-section">
                        <h3 id="sharedHeader">Shared (<span id="sharedCount2">0</span>)</h3>
                        <div class="peptide-list" id="sharedList"></div>
                        <div class="truncation-note" id="sharedNote" style="display:none;">Showing first 100 peptides</div>
                    </div>
                    <div class="peptide-section">
                        <h3 id="unique2Header">Unique to Run 2 (<span id="unique2Count">0</span>)</h3>
                        <div class="peptide-list" id="unique2List"></div>
                        <div class="truncation-note" id="unique2Note" style="display:none;">Showing first 100 peptides</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/static/login.html';
        }

        const params = new URLSearchParams(window.location.search);
        const preselectRun1 = params.get('run1');
        const preselectRun2 = params.get('run2');

        let runs = [];
        let currentRun1Id = null;
        let currentRun2Id = null;

        loadRuns();

        async function loadRuns() {
            try {
                const res = await fetch('/runs', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!res.ok) {
                    if (res.status === 401) {
                        window.location.href = '/static/login.html';
                        return;
                    }
                    throw new Error(`API Error: ${res.status}`);
                }

                const responseData = await res.json();
                runs = responseData.runs;
                if (!runs) {
                    throw new Error("Invalid response format from /runs endpoint");
                }

                populateSelects();
            } catch (e) {
                showError(`Error loading runs: ${e.message}`);
            }
        }

        function populateSelects() {
            const run1Select = document.getElementById('run1Select');
            const run2Select = document.getElementById('run2Select');
            const compareBtn = document.getElementById('compareBtn');
            const compareBtnHero = document.getElementById('compareBtnHero');

            if (runs.length < 2) {
                run1Select.innerHTML = '<option>Need at least 2 runs to compare</option>';
                run2Select.innerHTML = '<option>Need at least 2 runs to compare</option>';
                return;
            }

            const options = runs.map(r =>
                `<option value="${r.run_id}">${r.run_id} (${r.n_features} features)</option>`
            ).join('');

            run1Select.innerHTML = options;
            run2Select.innerHTML = options;

            if (preselectRun1) {
                const idx1 = runs.findIndex(r => r.run_id === preselectRun1);
                if (idx1 >= 0) run1Select.selectedIndex = idx1;
            }
            if (preselectRun2) {
                const idx2 = runs.findIndex(r => r.run_id === preselectRun2);
                if (idx2 >= 0) run2Select.selectedIndex = idx2;
            }
            if (!preselectRun1 && !preselectRun2 && runs.length >= 2) {
                run2Select.selectedIndex = 1;
            }

            run1Select.disabled = false;
            run2Select.disabled = false;
            compareBtn.disabled = false;
            if (compareBtnHero) {
                compareBtnHero.disabled = false;
            }

            if (preselectRun1 && preselectRun2 && preselectRun1 !== preselectRun2) {
                document.getElementById('compareBtn').click();
            }
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function showWarning(message) {
            const container = document.getElementById('warningContainer');
            container.innerHTML = `<div class="warning-message">${message}</div>`;
        }

        function clearWarning() {
            document.getElementById('warningContainer').innerHTML = '';
        }

        function getRunLabel(runId) {
            const run = runs.find(r => r.run_id === runId);
            if (!run) return runId;
            return runId;
        }

        async function compareRuns() {
            const run1 = document.getElementById('run1Select').value;
            const run2 = document.getElementById('run2Select').value;
            const compareBtnHero = document.getElementById('compareBtnHero');

            currentRun1Id = run1;
            currentRun2Id = run2;

            clearError();
            clearWarning();

            if (!run1 || !run2) return;

            if (run1 === run2) {
                showError('Please select two different runs to compare.');
                return;
            }

            const compareBtn = document.getElementById('compareBtn');
            compareBtn.innerHTML = 'Comparing<span class="loading-spinner"></span>';
            compareBtn.disabled = true;
            if (compareBtnHero) {
                compareBtnHero.disabled = true;
            }

            try {
                const res = await fetch(`/compare/${run1}/${run2}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!res.ok) {
                    if (res.status === 404) {
                        throw new Error('These runs cannot be compared (missing or invalid inputs).');
                    } else if (res.status === 400) {
                        throw new Error('These runs cannot be compared (no shared peptides or invalid inputs).');
                    } else if (res.status === 401) {
                        window.location.href = '/static/login.html';
                        return;
                    } else {
                        throw new Error(`Server error (${res.status}). Please try again.`);
                    }
                }

                const data = await res.json();
                displayResults(data);
            } catch (e) {
                showError(`Could not compare these runs. ${e.message}`);
            } finally {
                compareBtn.innerHTML = 'Compare';
                compareBtn.disabled = false;
                if (compareBtnHero) {
                    compareBtnHero.disabled = false;
                }
            }
        }

        function displayResults(data) {
            document.getElementById('results').style.display = 'block';

            const run1Label = getRunLabel(currentRun1Id);
            const run2Label = getRunLabel(currentRun2Id);

            document.getElementById('unique1Header').innerHTML =
                `Unique to <span class="run-label">${run1Label}</span> (<span id="unique1Count">${data.stats.unique_run_1_count}</span>)`;
            document.getElementById('sharedHeader').innerHTML =
                `Shared (<span id="sharedCount2">${data.stats.shared_count}</span>)`;
            document.getElementById('unique2Header').innerHTML =
                `Unique to <span class="run-label">${run2Label}</span> (<span id="unique2Count">${data.stats.unique_run_2_count}</span>)`;

            if (data.stats.jaccard_index === 1.0) {
                showWarning('These runs appear to be identical (Jaccard index = 1.0).');
            } else if (data.stats.shared_count === 0) {
                showWarning('These runs have no shared peptides (Jaccard index = 0.0).');
            } else {
                clearWarning();
            }

            document.getElementById('run1Total').textContent = data.stats.total_run_1;
            document.getElementById('run2Total').textContent = data.stats.total_run_2;
            document.getElementById('sharedCount').textContent = data.stats.shared_count;

            const jaccardValue = data.stats.jaccard_index;
            document.getElementById('jaccardIndex').textContent =
                (jaccardValue !== null && !isNaN(jaccardValue)) ? jaccardValue.toFixed(3) : '0.000';

            displayPeptideList('unique1List', data.unique_run_1, 'unique1', 'No unique peptides', currentRun1Id);
            displayPeptideList('sharedList', data.shared_peptides, 'shared', 'No shared peptides', currentRun1Id);
            displayPeptideList('unique2List', data.unique_run_2, 'unique2', 'No unique peptides', currentRun2Id);

            document.getElementById('unique1Note').style.display =
                data.unique_run_1.length >= 100 ? 'block' : 'none';
            document.getElementById('sharedNote').style.display =
                data.shared_peptides.length >= 100 ? 'block' : 'none';
            document.getElementById('unique2Note').style.display =
                data.unique_run_2.length >= 100 ? 'block' : 'none';
        }

        function displayPeptideList(elementId, peptides, className, emptyMessage, runId) {
            const container = document.getElementById(elementId);

            if (!peptides || peptides.length === 0) {
                container.innerHTML = `<div class="empty-state">${emptyMessage}</div>`;
                return;
            }

            container.innerHTML = peptides
                .map(p => `<div class="peptide-item ${className}" onclick="searchPeptide('${runId}', '${p}')" title="Click to search for similar peptides">${p}</div>`)
                .join('');
        }

        function searchPeptide(runId, peptideSeq) {
            window.location.href = `/static/search.html?run_id=${runId}&peptide=${encodeURIComponent(peptideSeq)}`;
        }
    </script>
</body>
</html>
