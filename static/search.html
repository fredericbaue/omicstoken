<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Peptide Similarity Search | Immuno-Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid #111827;
      background: #020617;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header .sub {
      font-size: 11px;
      opacity: 0.7;
    }
    header nav a {
      color: #9ca3af;
      text-decoration: none;
      font-size: 12px;
      margin-left: 12px;
    }
    header nav a:hover {
      color: #e5e7eb;
    }
    main {
      padding: 16px 20px 28px;
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1.5fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 14px 16px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
    }
    .card h2 {
      font-size: 16px;
      margin: 0 0 8px;
    }
    .card h3 {
      font-size: 14px;
      margin: 16px 0 6px;
    }
    .status {
      font-size: 12px;
      min-height: 16px;
      margin-top: 4px;
    }
    .status span.ok { color: #4ade80; }
    .status span.err { color: #f97316; }
    .status span.info { color: #60a5fa; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      margin-right: 6px;
    }
    .badge strong {
      font-weight: 600;
    }

    .peptide-table,
    .neighbors-box {
      border-radius: 8px;
      border: 1px solid #1f2937;
      margin-top: 6px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th,
    td {
      padding: 4px 6px;
      border-bottom: 1px solid #111827;
      white-space: nowrap;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #020617;
      z-index: 1;
      font-weight: 500;
    }
    tbody tr:hover {
      background: #0b1120;
      cursor: pointer;
    }

    .explanation {
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
      background: #020617;
      max-height: 220px;
      overflow-y: auto;
    }

    .neighbors-item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 2px 6px;
      border-bottom: 1px dashed #111827;
    }
    .neighbors-item:last-child {
      border-bottom: none;
    }
    .neighbors-item span.seq {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .neighbors-item span.small {
      font-size: 11px;
      opacity: 0.85;
    }
    .context-banner {
      margin: 8px 0 12px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #0b1120;
      font-size: 12px;
    }
    .auto-highlight {
      outline: 1px solid #38bdf8;
      background: #0b1120;
    }

    code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #020617;
      padding: 1px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Peptide Similarity Search</h1>
      <div class="sub">
        Run-level nearest neighbors over FAISS embeddings
      </div>
    </div>
    <nav>
      <a href="/static/runs.html">My Runs</a>
      <a href="/static/upload.html">Upload</a>
      <a href="/docs" target="_blank">API Docs</a>
    </nav>
  </header>

  <div id="contextBanner" class="context-banner" style="display:none;"></div>

  <main>
    <!-- LEFT: Peptide table -->
    <section class="card">
      <h2>1. Choose a peptide</h2>
      <div style="font-size:12px; margin-bottom:4px;">
        <span class="badge">
          <strong>Run:</strong> <span id="runLabel">â€“</span>
        </span>
        <span class="badge">
          <strong>Feature:</strong> <span id="featureLabel">none</span>
        </span>
      </div>
      <p style="margin:4px 0 6px; font-size:12px; opacity:0.8;">
        These are the top peptides from <code>/dashboard-data/{run_id}</code>. Click any row to search for neighbors.
      </p>
      <div class="peptide-table" id="peptideTable"></div>
      <div class="status" id="peptideStatus"></div>
    </section>

    <!-- RIGHT: Neighbors + explanation -->
    <section class="card">
      <h2>2. Neighbors & context</h2>
      <h3>Nearest neighbors in this run</h3>
      <div class="neighbors-box" id="neighborsBox">
        <div style="font-size:12px; opacity:0.7; padding:6px 8px;">
          Select a peptide on the left to find its nearest neighbors.
        </div>
      </div>

      <h3>Selected peptide explanation</h3>
      <div class="explanation" id="explanationBox">
        When you click a peptide, this will show the AI explanation from <code>/peptide/explain/{run_id}/{feature_id}</code>.
      </div>
      <div id="fullExplainLink" style="margin-top:6px; font-size:12px;"></div>

      <div class="status" id="explainStatus"></div>
    </section>
  </main>

  <script>
    const API_URL = "http://127.0.0.1:8080";
    const urlParams = new URLSearchParams(window.location.search);
    const runIdParam = urlParams.get("run_id");
    const featureIdParam = urlParams.get("feature_id");
    const sequenceParam = urlParams.get("sequence");
    let autoSearchDone = false;

    const runLabelEl = document.getElementById("runLabel");
    const featureLabelEl = document.getElementById("featureLabel");
    const peptideTableEl = document.getElementById("peptideTable");
    const peptideStatusEl = document.getElementById("peptideStatus");
    const neighborsBoxEl = document.getElementById("neighborsBox");
    const explanationBoxEl = document.getElementById("explanationBox");
    const explainStatusEl = document.getElementById("explainStatus");
    const contextBannerEl = document.getElementById("contextBanner");
    const fullExplainLinkEl = document.getElementById("fullExplainLink");

    function setStatus(el, msg, type = "info") {
      if (!el) return;
      el.innerHTML = "";
      if (!msg) return;
      const span = document.createElement("span");
      span.className = type;
      span.textContent = msg;
      el.appendChild(span);
    }

    function setContextBanner(msg, type = "info") {
      if (!contextBannerEl) return;
      if (!msg) {
        contextBannerEl.style.display = "none";
        contextBannerEl.textContent = "";
        return;
      }
      contextBannerEl.style.display = "block";
      contextBannerEl.textContent = msg;
      contextBannerEl.style.color =
        type === "ok" ? "#4ade80" : type === "err" ? "#f97316" : "#e5e7eb";
    }

    function getToken() {
      return window.localStorage.getItem("token") || "";
    }

    function authHeaders() {
      const token = getToken();
      const headers = {};
      if (token) headers["Authorization"] = "Bearer " + token;
      return headers;
    }

    function getRunIdFromQuery() {
      return runIdParam;
    }

    async function loadDashboardData(runId) {
      if (!runId) {
        setStatus(peptideStatusEl, "No run_id provided in query (?run_id=...).", "err");
        peptideTableEl.innerHTML = "";
        setContextBanner("", "info");
        return;
      }

      const token = getToken();
      if (!token) {
        setStatus(peptideStatusEl, "You must log in first (via login.html).", "err");
        peptideTableEl.innerHTML = "";
        setContextBanner("", "info");
        return;
      }

      setStatus(peptideStatusEl, "Loading peptides...", "info");
      peptideTableEl.innerHTML = "";

      try {
        const res = await fetch(`${API_URL}/dashboard-data/${encodeURIComponent(runId)}`, {
          headers: {
            ...authHeaders(),
          },
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.detail || JSON.stringify(data));
        }

        const items = data.data || [];
        if (!items.length) {
          peptideTableEl.innerHTML =
            "<div style='padding:6px 8px; font-size:12px; opacity:0.7;'>No peptides found for this run.</div>";
          setStatus(peptideStatusEl, "", "info");
          setContextBanner("", "info");
          return;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML =
          "<tr><th>Feature ID</th><th>Sequence</th><th>Intensity</th><th>Len</th><th>Charge</th><th>Hydro.</th></tr>";
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        let autoTarget = null;

        items.forEach((row) => {
          const props = row.properties || {};
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.feature_id}</td>
            <td>${row.sequence}</td>
            <td>${row.intensity ?? ""}</td>
            <td>${props.length ?? ""}</td>
            <td>${props.charge ?? ""}</td>
            <td>${props.hydrophobicity ?? ""}</td>
          `;
          if (featureIdParam && String(row.feature_id) === String(featureIdParam)) {
            tr.classList.add("auto-highlight");
            autoTarget = { row, element: tr };
          }
          tr.addEventListener("click", () => {
            onSelectPeptide(runId, row.feature_id, row.sequence);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        peptideTableEl.innerHTML = "";
        peptideTableEl.appendChild(table);
        setStatus(peptideStatusEl, "Click a row to search for neighbors.", "ok");

        if (featureIdParam && !autoSearchDone) {
          if (autoTarget) {
            setContextBanner(
              `Showing neighbors for peptide ${autoTarget.row.sequence || autoTarget.row.feature_id} (Run ${runId}).`,
              "ok"
            );
            autoSearchDone = true;
            onSelectPeptide(runId, autoTarget.row.feature_id, autoTarget.row.sequence);
          } else {
            setContextBanner(
              `Peptide ${featureIdParam} not found in run ${runId}. Please select a different peptide.`,
              "err"
            );
            setStatus(peptideStatusEl, "Peptide not found; select another.", "err");
          }
        } else if (!featureIdParam) {
          setContextBanner("");
        }
      } catch (err) {
        console.error(err);
        peptideTableEl.innerHTML = "";
        setStatus(peptideStatusEl, "Failed to load peptides: " + err.message, "err");
        setContextBanner("", "info");
      }
    }

    async function onSelectPeptide(runId, featureId, sequence) {
      featureLabelEl.textContent = `${featureId} (${sequence})`;
      setContextBanner(`Showing neighbors for peptide ${sequence || featureId} (Run ${runId}).`, "ok");
      neighborsBoxEl.innerHTML =
        "<div style='font-size:12px; opacity:0.7; padding:6px 8px;'>Searching neighbors...</div>";
      explanationBoxEl.textContent = "Requesting explanation...";
      if (fullExplainLinkEl) fullExplainLinkEl.innerHTML = "";
      setStatus(explainStatusEl, "", "info");

      const token = getToken();
      if (!token) {
        setStatus(explainStatusEl, "You must log in first (via login.html).", "err");
        return;
      }

      try {
        // 1) Similarity search
        const searchRes = await fetch(
          `${API_URL}/peptide/search/${encodeURIComponent(runId)}/${encodeURIComponent(featureId)}?k=10`,
          {
            headers: {
              ...authHeaders(),
            },
          }
        );
        const searchData = await searchRes.json();
        if (!searchRes.ok) {
          throw new Error(searchData.detail || JSON.stringify(searchData));
        }

        const neighbors = searchData.neighbors || [];
        if (!neighbors.length) {
          neighborsBoxEl.innerHTML =
            "<div style='font-size:12px; opacity:0.7; padding:6px 8px;'>No neighbors found in this run.</div>";
        } else {
          const container = document.createElement("div");
          neighbors.forEach((n) => {
            const div = document.createElement("div");
            div.className = "neighbors-item";
            div.innerHTML = `
              <span class="seq">${n.peptide_sequence || ""}</span>
              <span class="small">sim=${(n.similarity ?? n.similarity_score ?? 0).toFixed(3)}</span>
              <span class="small">int=${n.intensity ?? ""}</span>
            `;
            container.appendChild(div);
          });
          neighborsBoxEl.innerHTML = "";
          neighborsBoxEl.appendChild(container);
        }

        // 2) Explanation
        try {
          const expRes = await fetch(
            `${API_URL}/peptide/explain/${encodeURIComponent(runId)}/${encodeURIComponent(featureId)}`,
            {
              headers: {
                ...authHeaders(),
              },
            }
          );
          const expData = await expRes.json();
          if (!expRes.ok) {
            throw new Error(expData.detail || JSON.stringify(expData));
          }
          explanationBoxEl.textContent =
            expData.explanation ||
            expData.summary_text ||
            JSON.stringify(expData, null, 2);
          if (fullExplainLinkEl) {
            const url = `/static/explain.html?run_id=${encodeURIComponent(runId)}&feature_id=${encodeURIComponent(featureId)}`;
            fullExplainLinkEl.innerHTML = `<a href="${url}" style="color:#60a5fa; text-decoration:none;">Open full explanation view &rarr;</a>`;
          }
          setStatus(explainStatusEl, "", "info");
        } catch (expErr) {
          console.error(expErr);
          explanationBoxEl.textContent = "Failed to get explanation: " + expErr.message;
          setStatus(explainStatusEl, "Explanation failed.", "err");
        }
      } catch (err) {
        console.error(err);
        neighborsBoxEl.innerHTML =
          "<div style='font-size:12px; opacity:0.7; padding:6px 8px;'>No neighbors.</div>";
        explanationBoxEl.textContent = "Failed to search neighbors: " + err.message;
        setStatus(explainStatusEl, "Neighbor search failed.", "err");
      }
    }

    // --- Init ---
    (function init() {
      const runId = getRunIdFromQuery();
      runLabelEl.textContent = runId || "none";
      if (!runId) {
        setStatus(peptideStatusEl, "Add ?run_id=YOUR_RUN_ID to the URL.", "err");
        return;
      }
      loadDashboardData(runId);
    })();
  </script>
</body>
</html>
