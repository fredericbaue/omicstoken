<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Peptide Similarity Search | OmicsToken</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/style.css">
  <style>
    :root {
      --shell-bg: rgba(15, 23, 42, 0.92);
      --shell-border: rgba(148, 163, 184, 0.25);
      --text-body: #e5e7eb;
      --text-muted: rgba(226, 232, 240, 0.75);
      --surface: rgba(2, 6, 23, 0.7);
      --accent: linear-gradient(135deg, #6366f1, #22c1c3);
    }
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body.search-body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "SF Pro Text", -apple-system, system-ui, sans-serif;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
      color: var(--text-body);
    }
    .search-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2.75rem 1.75rem 4rem;
    }
    .search-hero {
      display: flex;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
      background: var(--shell-bg);
      border: 1px solid var(--shell-border);
      border-radius: 28px;
      padding: 2rem 2.25rem;
      box-shadow: 0 30px 80px rgba(2, 6, 23, 0.75);
      margin-bottom: 1.75rem;
    }
    .search-hero-copy h1 {
      font-size: 2.2rem;
      margin: 0.4rem 0 0.5rem;
      letter-spacing: -0.02em;
      background: linear-gradient(120deg, #38bdf8, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .search-kicker {
      text-transform: uppercase;
      font-size: 0.78rem;
      letter-spacing: 0.32em;
      color: rgba(148, 163, 184, 0.9);
      margin: 0;
    }
    .search-hero-copy p {
      margin: 0;
      color: var(--text-muted);
      max-width: 46ch;
      line-height: 1.6;
    }
    .search-hero-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-start;
    }
    .hero-links {
      display: flex;
      gap: 0.65rem;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: 0.75rem 1.4rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 22px 45px rgba(79, 70, 229, 0.55);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--text-body);
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .search-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.3fr);
      gap: 1.5rem;
    }
    @media (max-width: 1024px) {
      .search-grid {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 24px;
      padding: 1.75rem 1.9rem;
      box-shadow: 0 24px 65px rgba(2, 6, 23, 0.7);
    }
    .card h2 {
      margin: 0 0 0.65rem;
      font-size: 1.35rem;
      letter-spacing: 0.01em;
    }
    .card h3 {
      margin: 1.4rem 0 0.5rem;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }
    .badge-group {
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(2, 6, 23, 0.7);
    }
    .badge strong {
      font-weight: 600;
      letter-spacing: 0.05em;
    }
    .peptide-table,
    .neighbors-box,
    .explanation {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: var(--surface);
      margin-top: 0.75rem;
      max-height: 320px;
      overflow-y: auto;
      font-size: 0.9rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th,
    td {
      padding: 0.55rem 0.75rem;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      white-space: nowrap;
      font-size: 0.85rem;
    }
    thead th {
      position: sticky;
      top: 0;
      background: rgba(2, 6, 23, 0.95);
      z-index: 1;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.75rem;
    }
    tbody tr:hover {
      background: rgba(56, 189, 248, 0.12);
      cursor: pointer;
    }
    .neighbors-item {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.35rem 0.75rem;
      border-bottom: 1px dashed rgba(15, 23, 42, 0.65);
    }
    .neighbors-item:last-child {
      border-bottom: none;
    }
    .neighbors-item span.seq {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color: #38bdf8;
    }
    .neighbors-item span.small {
      font-size: 0.78rem;
      color: var(--text-muted);
    }
    .explanation {
      padding: 1rem 1.2rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .status {
      font-size: 0.85rem;
      min-height: 1rem;
      margin-top: 0.75rem;
    }
    .status span.ok { color: #4ade80; }
    .status span.err { color: #f97316; }
    .status span.info { color: #60a5fa; }
    .context-banner {
      display: none;
      margin: 0 0 1.5rem;
      padding: 1rem 1.2rem;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.85);
      font-size: 0.95rem;
    }
    code {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.85rem;
      background: rgba(15, 23, 42, 0.7);
      padding: 0.15rem 0.3rem;
      border-radius: 4px;
    }
    .auto-highlight {
      outline: 1px solid #38bdf8;
      background: rgba(15, 118, 110, 0.25);
    }
    .link-muted {
      color: rgba(148, 163, 184, 0.95);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .link-muted:hover {
      color: #fff;
    }
  </style>
</head>
<body class="search-body">
  <main class="search-shell">
    <section class="search-hero">
      <div class="search-hero-copy">
        <p class="search-kicker">Vector search</p>
        <h1>Peptide Similarity Search</h1>
        <p>Explore FAISS nearest neighbors for any peptide in a run. Perfect for explaining overlap, finding analogues, or showcasing the intelligence behind OmicsToken.</p>
      </div>
      <div class="search-hero-actions">
        <div class="hero-links">
            <a href="/static/runs.html" class="btn btn-primary">Back to Runs</a>
            <a href="/static/upload.html" class="btn btn-secondary">Upload Data</a>
        </div>
        <a class="link-muted" href="/docs" target="_blank">API Docs →</a>
      </div>
    </section>

    <div id="contextBanner" class="context-banner"></div>

    <div class="search-grid">
      <section class="card">
        <h2>1. Choose a peptide</h2>
        <div class="badge-group">
          <span class="badge"><strong>Run</strong> <span id="runLabel">—</span></span>
          <span class="badge"><strong>Feature</strong> <span id="featureLabel">none</span></span>
        </div>
        <p style="margin:0;font-size:0.95rem;color:var(--text-muted);">
          These are the top peptides from <code>/dashboard-data/{run_id}</code>. Click any row to search for neighbors.
        </p>
        <div class="peptide-table" id="peptideTable"></div>
        <div class="status" id="peptideStatus"></div>
      </section>

      <section class="card">
        <h2>2. Neighbors & context</h2>
        <h3>Nearest neighbors</h3>
        <div class="neighbors-box" id="neighborsBox">
          <div style="font-size:0.9rem;opacity:0.7;padding:0.8rem;">
            Select a peptide to retrieve its latent-space neighbors.
          </div>
        </div>
        <h3>AI explanation</h3>
        <div class="explanation" id="explanationBox">
          When you click a peptide, this will show the AI explanation from <code>/peptide/explain/{run_id}/{feature_id}</code>.
        </div>
        <div id="fullExplainLink" style="margin-top:0.75rem;font-size:0.9rem;"></div>
        <div class="status" id="explainStatus"></div>
      </section>
    </div>
  </main>

  <script>
    const API_URL = "http://127.0.0.1:8080";
    const urlParams = new URLSearchParams(window.location.search);
    const runIdParam = urlParams.get("run_id");
    const featureIdParam = urlParams.get("feature_id");
    const sequenceParam = urlParams.get("sequence");
    let autoSearchDone = false;

    const runLabelEl = document.getElementById("runLabel");
    const featureLabelEl = document.getElementById("featureLabel");
    const peptideTableEl = document.getElementById("peptideTable");
    const peptideStatusEl = document.getElementById("peptideStatus");
    const neighborsBoxEl = document.getElementById("neighborsBox");
    const explanationBoxEl = document.getElementById("explanationBox");
    const explainStatusEl = document.getElementById("explainStatus");
    const contextBannerEl = document.getElementById("contextBanner");
    const fullExplainLinkEl = document.getElementById("fullExplainLink");

    function setStatus(el, msg, type = "info") {
      if (!el) return;
      el.innerHTML = "";
      if (!msg) return;
      const span = document.createElement("span");
      span.className = type;
      span.textContent = msg;
      el.appendChild(span);
    }

    function setContextBanner(msg, type = "info") {
      if (!contextBannerEl) return;
      if (!msg) {
        contextBannerEl.style.display = "none";
        contextBannerEl.textContent = "";
        return;
      }
      contextBannerEl.style.display = "block";
      contextBannerEl.textContent = msg;
      contextBannerEl.style.color =
        type === "ok" ? "#4ade80" : type === "err" ? "#f97316" : "#e5e7eb";
    }

    function getToken() {
      return window.localStorage.getItem("token") || "";
    }

    function authHeaders() {
      const token = getToken();
      const headers = {};
      if (token) headers["Authorization"] = "Bearer " + token;
      return headers;
    }

    function getRunIdFromQuery() {
      return runIdParam;
    }

    async function loadDashboardData(runId) {
      if (!runId) {
        setStatus(peptideStatusEl, "No run_id provided in query (?run_id=...).", "err");
        peptideTableEl.innerHTML = "";
        setContextBanner("", "info");
        return;
      }

      const token = getToken();
      if (!token) {
        setStatus(peptideStatusEl, "You must log in first (via login.html).", "err");
        peptideTableEl.innerHTML = "";
        setContextBanner("", "info");
        return;
      }

      setStatus(peptideStatusEl, "Loading peptides...", "info");
      peptideTableEl.innerHTML = "";

      try {
        const res = await fetch(`${API_URL}/dashboard-data/${encodeURIComponent(runId)}`, {
          headers: {
            ...authHeaders(),
          },
        });
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.detail || JSON.stringify(data));
        }

        const items = data.data || [];
        if (!items.length) {
          peptideTableEl.innerHTML =
            "<div style='padding:0.8rem;font-size:0.9rem;opacity:0.65;'>No peptides found for this run.</div>";
          setStatus(peptideStatusEl, "", "info");
          setContextBanner("", "info");
          return;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML =
          "<tr><th>Feature ID</th><th>Sequence</th><th>Intensity</th><th>Len</th><th>Charge</th><th>Hydro.</th></tr>";
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        let autoTarget = null;

        items.forEach((row) => {
          const props = row.properties || {};
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.feature_id}</td>
            <td>${row.sequence}</td>
            <td>${row.intensity ?? ""}</td>
            <td>${props.length ?? ""}</td>
            <td>${props.charge ?? ""}</td>
            <td>${props.hydrophobicity ?? ""}</td>
          `;
          if (featureIdParam && String(row.feature_id) === String(featureIdParam)) {
            tr.classList.add("auto-highlight");
            autoTarget = { row, element: tr };
          }
          tr.addEventListener("click", () => {
            onSelectPeptide(runId, row.feature_id, row.sequence);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        peptideTableEl.innerHTML = "";
        peptideTableEl.appendChild(table);
        setStatus(peptideStatusEl, "Click a row to search for neighbors.", "ok");

        if (featureIdParam && !autoSearchDone) {
          if (autoTarget) {
            setContextBanner(
              `Showing neighbors for peptide ${autoTarget.row.sequence || autoTarget.row.feature_id} (Run ${runId}).`,
              "ok"
            );
            autoSearchDone = true;
            onSelectPeptide(runId, autoTarget.row.feature_id, autoTarget.row.sequence);
          } else {
            setContextBanner(
              `Peptide ${featureIdParam} not found in run ${runId}. Please select a different peptide.`,
              "err"
            );
            setStatus(peptideStatusEl, "Peptide not found; select another.", "err");
          }
        } else {
          setContextBanner("");
        }
      } catch (err) {
        console.error(err);
        peptideTableEl.innerHTML = "";
        setStatus(peptideStatusEl, "Failed to load peptides: " + err.message, "err");
        setContextBanner("", "info");
      }
    }

    async function onSelectPeptide(runId, featureId, sequence) {
      featureLabelEl.textContent = `${featureId} (${sequence})`;
      setContextBanner(`Showing neighbors for peptide ${sequence || featureId} (Run ${runId}).`, "ok");
      neighborsBoxEl.innerHTML =
        "<div style='font-size:0.9rem;opacity:0.7;padding:0.75rem;'>Searching neighbors...</div>";
      explanationBoxEl.textContent = "Requesting explanation...";
      if (fullExplainLinkEl) fullExplainLinkEl.innerHTML = "";
      setStatus(explainStatusEl, "", "info");

      const token = getToken();
      if (!token) {
        setStatus(explainStatusEl, "You must log in first (via login.html).", "err");
        return;
      }

      try {
        const searchRes = await fetch(
          `${API_URL}/peptide/search/${encodeURIComponent(runId)}/${encodeURIComponent(featureId)}?k=10`,
          {
            headers: {
              ...authHeaders(),
            },
          }
        );
        const searchData = await searchRes.json();
        if (!searchRes.ok) {
          throw new Error(searchData.detail || JSON.stringify(searchData));
        }

        const neighbors = searchData.neighbors || [];
        if (!neighbors.length) {
          neighborsBoxEl.innerHTML =
            "<div style='font-size:0.9rem;opacity:0.7;padding:0.8rem;'>No neighbors found in this run.</div>";
        } else {
          const container = document.createElement("div");
          neighbors.forEach((n) => {
            const div = document.createElement("div");
            div.className = "neighbors-item";
            div.innerHTML = `
              <span class="seq">
                <a href="/static/search.html?run_id=${encodeURIComponent(runId || "")}&sequence=${encodeURIComponent(n.peptide_sequence || "")}" style="color:#38bdf8;text-decoration:none;">
                  ${n.peptide_sequence || ""}
                </a>
              </span>
              <span class="small">sim ${(n.similarity ?? n.similarity_score ?? 0).toFixed(3)}</span>
              <span class="small">int ${n.intensity ?? ""}</span>
            `;
            container.appendChild(div);
          });
          neighborsBoxEl.innerHTML = "";
          neighborsBoxEl.appendChild(container);
        }

        try {
          const expRes = await fetch(
            `${API_URL}/peptide/explain/${encodeURIComponent(runId)}/${encodeURIComponent(featureId)}`,
            {
              headers: {
                ...authHeaders(),
              },
            }
          );
          const expData = await expRes.json();
          if (!expRes.ok) {
            throw new Error(expData.detail || JSON.stringify(expData));
          }
          explanationBoxEl.textContent =
            expData.explanation ||
            expData.summary_text ||
            JSON.stringify(expData, null, 2);
          if (fullExplainLinkEl) {
            const url = `/static/explain.html?run_id=${encodeURIComponent(runId)}&feature_id=${encodeURIComponent(featureId)}`;
            fullExplainLinkEl.innerHTML = `<a href="${url}" style="color:#60a5fa;text-decoration:none;">Open full explanation view →</a>`;
          }
          setStatus(explainStatusEl, "", "info");
        } catch (expErr) {
          console.error(expErr);
          explanationBoxEl.textContent = "Failed to get explanation: " + expErr.message;
          setStatus(explainStatusEl, "Explanation failed.", "err");
        }
      } catch (err) {
        console.error(err);
        neighborsBoxEl.innerHTML =
          "<div style='font-size:0.9rem;opacity:0.7;padding:0.8rem;'>No neighbors.</div>";
        explanationBoxEl.textContent = "Failed to search neighbors: " + err.message;
        setStatus(explainStatusEl, "Neighbor search failed.", "err");
      }
    }

    (function init() {
      const runId = getRunIdFromQuery();
      runLabelEl.textContent = runId || "none";
      if (!runId) {
        setStatus(peptideStatusEl, "Add ?run_id=YOUR_RUN_ID to the URL.", "err");
        return;
      }
      loadDashboardData(runId);
    })();
  </script>
</body>
</html>
