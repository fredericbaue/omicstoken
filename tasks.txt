# Codex Tasks â€“ OmicsToken MVP Engineering Guide

This file defines the tasks Codex should prioritize when generating or modifying
code. It is ordered: MVP-critical tasks first, then structural tasks, then
future enhancements. Codex must read this after codex_core_context.txt and
codex_memory_log.md.

======================================================================
## ğŸ”¥ 0. Absolute Rule (Non-Negotiable)
NEVER break the pipeline:

Upload â†’ Parse â†’ Store Features â†’ Embed â†’ Store Embeddings â†’ Rebuild Index â†’
Search â†’ Compare â†’ Summarize â†’ Export.

All code changes must preserve this end-to-end flow.

======================================================================
## 1 MVP-Critical (Do These First)
[ ] 1 Fix & Harden Export Authentication
- Ensure export_run.py uses valid Bearer tokens by default and clearly reports
  401 errors and missing tokens.
- Optionally add a local "demo token" path for offline demos that is safe but
  convenient.
- Guarantee that /export/embeddings/{run_id} consistently returns the canonical
  OmicsToken v1 export payload for any run that has embeddings.

[ ]  1.2 Harden FAISS Index Rebuild
- Make search.rebuild_faiss_index safe and idempotent when called after each
  embedding operation.
- Ensure index rebuild cannot corrupt the index if interrupted.
- Add basic error handling and logging when index rebuild fails so the demo
  can degrade gracefully instead of crashing.

[ ]  1.3 Stabilize ESM-2 Embedding Engine
- Avoid repeated model reloads by ensuring get_model() uses a proper global cache.
- Validate sequences early (strip/uppercase, non-empty) to minimize failed calls.
- Add explicit tests that EMBEDDING_DIM == 320 and all stored embeddings match
  this length.


[ ]  1.4 Background Task & DB Safety
- Verify that embed(run_id) and its DB access pattern are safe when called from
  a threadpool.
- Avoid DB connection reuse across threads; ensure each task uses its own
  connection.
- Ensure concurrent uploads/embeddings cannot corrupt the DB or index.

[ ]  1.5 Endpoint Robustness
- Ensure all user-scoped routes enforce run ownership (current_active_user).
- On errors, return clear HTTPException messages rather than crashing.

======================================================================
[ ]  ğŸ§± 2. Structural Code Quality Tasks

[ ]  2.1 Separate Legacy Tables From Current Logic
- Clearly mark the old embeddings table in db.py as legacy.
- Prefer peptide_embeddings for all new work.
- Remove unused helper functions that reference obsolete tables or columns,
  unless needed for migration.

[ ] 2.2 Introduce a Formal Embedder Interface
- Add a BaseEmbedder class, then wrap ESM-2 inside it:
  ```python
  class BaseEmbedder:
      def embed(self, sequence: str) -> np.ndarray:
          ...
